<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ•°æ®åˆ†æç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls label {
            font-weight: bold;
            color: #555;
        }

        .controls input {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .controls input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #888;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .value {
            color: #333;
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .trend {
            color: #11998e;
            font-size: 14px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .chart-card h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .chart-container {
            height: 350px;
        }

        .ai-analysis {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .ai-analysis h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-icon {
            font-size: 28px;
        }

        .ai-content {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            min-height: 200px;
            color: #555;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .controls input,
            .controls .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- å¤´éƒ¨ -->
    <div class="header">
        <h1>ğŸ¯ æ™ºèƒ½æ•°æ®åˆ†æç³»ç»Ÿ</h1>
        <p>åŸºäº Elasticsearch + Spring AI çš„æ™ºèƒ½åé¦ˆåˆ†æå¹³å°</p>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="controls">
        <label>å¼€å§‹æ—¥æœŸï¼š</label>
        <input type="date" id="startDate" value="">

        <label>ç»“æŸæ—¥æœŸï¼š</label>
        <input type="date" id="endDate" value="">

        <button class="btn btn-primary" onclick="loadData()">
            ğŸ“Š åŠ è½½æ•°æ®
        </button>

        <button class="btn btn-success" id="analyzeBtn" onclick="generateAIAnalysis()" disabled>
            ğŸ¤– AI æ™ºèƒ½åˆ†æ
        </button>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>æ€»åé¦ˆæ•°</h3>
            <div class="value" id="totalCount">-</div>
            <div class="trend">å¾…åŠ è½½æ•°æ®</div>
        </div>
        <div class="stat-card">
            <h3>å¹³å‡æ»¡æ„åº¦</h3>
            <div class="value" id="avgSatisfaction">-</div>
            <div class="trend">5åˆ†åˆ¶è¯„åˆ†</div>
        </div>
        <div class="stat-card">
            <h3>å›å¤ç‡</h3>
            <div class="value" id="replyRate">-</div>
            <div class="trend">å·²å›å¤/æ€»æ•°</div>
        </div>
        <div class="stat-card">
            <h3>å¤„ç†ä¸­</h3>
            <div class="value" id="handlingCount">-</div>
            <div class="trend">å½“å‰è¿›è¡Œä¸­</div>
        </div>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="charts-grid">
        <div class="chart-card">
            <h2>ğŸ“ˆ æ¯æ—¥è¶‹åŠ¿åˆ†æ</h2>
            <div class="chart-container" id="trendChart"></div>
        </div>

        <div class="chart-card">
            <h2>ğŸ“Š å¤„ç†çŠ¶æ€åˆ†å¸ƒ</h2>
            <div class="chart-container" id="statusChart"></div>
        </div>

        <div class="chart-card">
            <h2>ğŸ¢ ç»„ç»‡æœºæ„åˆ†å¸ƒ</h2>
            <div class="chart-container" id="orgChart"></div>
        </div>

        <div class="chart-card">
            <h2>ğŸ·ï¸ é—®é¢˜é¢†åŸŸåˆ†å¸ƒ</h2>
            <div class="chart-container" id="fieldChart"></div>
        </div>
    </div>

    <!-- AI åˆ†æåŒºåŸŸ -->
    <div class="ai-analysis">
        <h2>
            <span class="ai-icon">ğŸ¤–</span>
            AI æ™ºèƒ½åˆ†ææŠ¥å‘Š
        </h2>
        <div class="ai-content" id="aiContent">
            <div class="empty-state">
                ç‚¹å‡»ä¸Šæ–¹ "AI æ™ºèƒ½åˆ†æ" æŒ‰é’®ï¼Œè·å–ä¸“ä¸šçš„æ•°æ®åˆ†ææŠ¥å‘Š
            </div>
        </div>
        <div class="loading" id="aiLoading">
            <div class="spinner"></div>
            <p>AI æ­£åœ¨åˆ†ææ•°æ®ï¼Œè¯·ç¨å€™...</p>
        </div>
    </div>
</div>

<script>
    // API åŸºç¡€ URL
    const API_BASE = 'http://localhost:8080/api';

    // å½“å‰æ•°æ®
    let currentData = null;

    // åˆå§‹åŒ–æ—¥æœŸ
    function initDates() {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        document.getElementById('endDate').valueAsDate = yesterday;
        document.getElementById('startDate').valueAsDate = yesterday;
    }

    // åŠ è½½æ•°æ®
    async function loadData() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (!startDate || !endDate) {
            alert('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´');
            return;
        }

        try {
            const response = await axios.get(`${API_BASE}/analysis/data`, {
                params: { startDate, endDate }
            });

            currentData = response.data;
            renderDashboard(currentData);
            document.getElementById('analyzeBtn').disabled = false;

        } catch (error) {
            console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            alert('åŠ è½½æ•°æ®å¤±è´¥: ' + (error.response?.data?.message || error.message));
        }
    }

    // æ¸²æŸ“ Dashboard
    function renderDashboard(data) {
        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
        document.getElementById('totalCount').textContent = data.total || 0;
        document.getElementById('avgSatisfaction').textContent =
            data.avgSatisfaction ? data.avgSatisfaction.toFixed(1) : '-';
        document.getElementById('replyRate').textContent = data.replyRate || '-';

        const statusDist = data.statusDistribution || {};
        const handlingCount = statusDist['å¤„ç†ä¸­'] || statusDist['HANDLING'] || 0;
        document.getElementById('handlingCount').textContent = handlingCount;

        // æ¸²æŸ“å›¾è¡¨
        renderTrendChart(data.dailyTrend || []);
        renderStatusChart(data.statusDistribution || {});
        renderOrgChart(data.organizationDistribution || {});
        renderFieldChart(data.fieldDistribution || {});
    }

    // æ¯æ—¥è¶‹åŠ¿å›¾
    function renderTrendChart(data) {
        const chart = echarts.init(document.getElementById('trendChart'));

        const dates = data.map(item => item.date);
        const counts = data.map(item => item.count);

        const option = {
            tooltip: {
                trigger: 'axis'
            },
            xAxis: {
                type: 'category',
                data: dates,
                axisLabel: {
                    rotate: 45
                }
            },
            yAxis: {
                type: 'value'
            },
            series: [{
                name: 'åé¦ˆæ•°é‡',
                type: 'line',
                data: counts,
                smooth: true,
                itemStyle: {
                    color: '#667eea'
                },
                areaStyle: {
                    color: {
                        type: 'linear',
                        x: 0, y: 0, x2: 0, y2: 1,
                        colorStops: [
                            { offset: 0, color: 'rgba(102, 126, 234, 0.5)' },
                            { offset: 1, color: 'rgba(102, 126, 234, 0.1)' }
                        ]
                    }
                }
            }],
            grid: {
                left: '3%',
                right: '4%',
                bottom: '15%',
                containLabel: true
            }
        };

        chart.setOption(option);
        window.addEventListener('resize', () => chart.resize());
    }

    // çŠ¶æ€åˆ†å¸ƒå›¾
    function renderStatusChart(data) {
        const chart = echarts.init(document.getElementById('statusChart'));

        const chartData = Object.entries(data).map(([name, value]) => ({
            name, value
        }));

        const option = {
            tooltip: {
                trigger: 'item',
                formatter: '{b}: {c} ({d}%)'
            },
            legend: {
                orient: 'vertical',
                right: 10,
                top: 'center'
            },
            series: [{
                name: 'å¤„ç†çŠ¶æ€',
                type: 'pie',
                radius: ['40%', '70%'],
                avoidLabelOverlap: false,
                itemStyle: {
                    borderRadius: 10,
                    borderColor: '#fff',
                    borderWidth: 2
                },
                label: {
                    show: false
                },
                emphasis: {
                    label: {
                        show: true,
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                data: chartData,
                color: ['#667eea', '#11998e', '#f093fb', '#4facfe', '#43e97b']
            }]
        };

        chart.setOption(option);
        window.addEventListener('resize', () => chart.resize());
    }

    // ç»„ç»‡åˆ†å¸ƒå›¾
    function renderOrgChart(data) {
        const chart = echarts.init(document.getElementById('orgChart'));

        const orgs = Object.keys(data);
        const values = Object.values(data);

        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                }
            },
            xAxis: {
                type: 'value'
            },
            yAxis: {
                type: 'category',
                data: orgs,
                axisLabel: {
                    interval: 0,
                    fontSize: 11
                }
            },
            series: [{
                name: 'åé¦ˆæ•°é‡',
                type: 'bar',
                data: values,
                itemStyle: {
                    color: {
                        type: 'linear',
                        x: 0, y: 0, x2: 1, y2: 0,
                        colorStops: [
                            { offset: 0, color: '#667eea' },
                            { offset: 1, color: '#764ba2' }
                        ]
                    },
                    borderRadius: [0, 10, 10, 0]
                }
            }],
            grid: {
                left: '25%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            }
        };

        chart.setOption(option);
        window.addEventListener('resize', () => chart.resize());
    }

    // é¢†åŸŸåˆ†å¸ƒå›¾
    function renderFieldChart(data) {
        const chart = echarts.init(document.getElementById('fieldChart'));

        const chartData = Object.entries(data).map(([name, value]) => ({
            name, value
        }));

        const option = {
            tooltip: {
                trigger: 'item',
                formatter: '{b}: {c} ({d}%)'
            },
            series: [{
                name: 'é—®é¢˜é¢†åŸŸ',
                type: 'pie',
                radius: '70%',
                data: chartData,
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                },
                color: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a']
            }]
        };

        chart.setOption(option);
        window.addEventListener('resize', () => chart.resize());
    }

    // ç”Ÿæˆ AI åˆ†æ
    async function generateAIAnalysis() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        document.getElementById('aiContent').style.display = 'none';
        document.getElementById('aiLoading').classList.add('active');
        document.getElementById('analyzeBtn').disabled = true;

        try {
            // åˆ¤æ–­æ˜¯å¦æ˜¯å•æ—¥åˆ†æ
            const isSingleDay = startDate === endDate;

            let response;
            if (isSingleDay) {
                response = await axios.get(`${API_BASE}/analysis/report/daily`, {
                    params: { date: startDate }
                });
            } else {
                // å¤šæ—¥æœŸæš‚æ—¶ä½¿ç”¨æ¯æ—¥æŠ¥å‘Šï¼ˆä¹Ÿå¯ä»¥æ‰©å±•ä¸ºå‘¨åº¦æŠ¥å‘Šï¼‰
                response = await axios.get(`${API_BASE}/analysis/report/daily`, {
                    params: { date: endDate }
                });
            }

            const report = response.data.report;

            // æ˜¾ç¤ºç»“æœ
            document.getElementById('aiContent').textContent = report;
            document.getElementById('aiContent').style.display = 'block';
            document.getElementById('aiLoading').classList.remove('active');

        } catch (error) {
            console.error('AI åˆ†æå¤±è´¥:', error);
            document.getElementById('aiContent').textContent =
                'âŒ AI åˆ†æå¤±è´¥: ' + (error.response?.data?.message || error.message);
            document.getElementById('aiContent').style.display = 'block';
            document.getElementById('aiLoading').classList.remove('active');
        } finally {
            document.getElementById('analyzeBtn').disabled = false;
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆ
    window.onload = function() {
        initDates();
        console.log('Dashboard å·²åŠ è½½');
    };
</script>
</body>
</html>